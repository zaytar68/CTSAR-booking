@*
====================================================================
MainLayout.razor : Layout principal de l'application
====================================================================
Ce composant d√©finit la structure globale de l'application avec
MudDrawer pour la navigation responsive et MudAppBar pour le header.
Utilise MudBlazor pour la gestion automatique du th√®me.
IMPORTANT : Les providers MudBlazor sont d√©finis ICI et UNIQUEMENT ICI.
*@

@inherits LayoutComponentBase
@inject ThemeService ThemeService
@implements IDisposable

@* MudBlazor Theme Provider : G√®re automatiquement le dark/light mode *@
<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Class="@(_isDarkMode ? "dark-theme" : "")">
    @* AppBar : Header avec bouton hamburger et contr√¥les *@
    <MudAppBar Elevation="1" Dense="false">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />
        <MudSpacer />
        <ThemeLanguageControls />
    </MudAppBar>

    @* Drawer : Menu de navigation responsive *@
    <MudDrawer @bind-Open="@_drawerOpen"
               Elevation="2"
               Variant="@DrawerVariant.Responsive"
               Breakpoint="Breakpoint.Md"
               ClipMode="DrawerClipMode.Never">
        <NavMenu />
    </MudDrawer>

    @* Contenu principal *@
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled exception has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">üóô</span>
</div>

@code {
    private bool _isDarkMode = false;
    private bool _drawerOpen = true;

    protected override async Task OnInitializedAsync()
    {
        // Initialiser le ThemeService et charger les pr√©f√©rences
        await ThemeService.InitializeAsync();

        // Charger l'√©tat du th√®me depuis le service
        _isDarkMode = ThemeService.IsDarkMode;

        // S'abonner aux changements de th√®me
        ThemeService.OnThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged()
    {
        // Mettre √† jour l'√©tat local quand le service change
        _isDarkMode = ThemeService.IsDarkMode;
        StateHasChanged();
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
