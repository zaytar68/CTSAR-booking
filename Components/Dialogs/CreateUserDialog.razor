@*
====================================================================
CreateUserDialog.razor : Dialogue de cr√©ation d'utilisateur
====================================================================
Ce dialogue permet aux administrateurs de cr√©er un nouvel utilisateur.
Utilise les composants MudBlazor pour une interface moderne et r√©active.
*@

@using System.ComponentModel.DataAnnotations
@using CTSAR.Booking.DTOs
@using CTSAR.Booking.Constants
@using CTSAR.Booking.Services
@using MudBlazor

@inject UserService UserService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid>
                @* ======================================================== *@
                @* INFORMATIONS PERSONNELLES                                *@
                @* ======================================================== *@
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Class="me-2" />
                        Informations personnelles
                    </MudText>
                    <MudDivider />
                </MudItem>

                @* Pr√©nom *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.Prenom"
                                  Label="Pr√©nom"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Le pr√©nom est obligatoire"
                                  MaxLength="100"
                                  Counter="100"
                                  Immediate="true"
                                  HelperText="Pr√©nom de l'utilisateur" />
                </MudItem>

                @* Nom *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.Nom"
                                  Label="Nom"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Le nom est obligatoire"
                                  MaxLength="100"
                                  Counter="100"
                                  Immediate="true"
                                  HelperText="Nom de famille de l'utilisateur" />
                </MudItem>

                @* Email *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Email"
                                  Label="Adresse email"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="L'email est obligatoire"
                                  InputType="InputType.Email"
                                  Validation="@(new EmailAddressAttribute() { ErrorMessage = "L'email n'est pas valide" })"
                                  Immediate="true"
                                  HelperText="Sera utilis√© comme identifiant de connexion" />
                </MudItem>

                @* T√©l√©phone *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.PhoneNumber"
                                  Label="T√©l√©phone"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Telephone"
                                  HelperText="Optionnel"
                                  Clearable="true" />
                </MudItem>

                @* Langue *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_model.PreferenceLangue"
                               Label="Langue pr√©f√©r√©e"
                               Variant="Variant.Outlined"
                               Required="true"
                               HelperText="Langue de l'interface">
                        <MudSelectItem Value="@("fr")">üá´üá∑ Fran√ßais</MudSelectItem>
                        <MudSelectItem Value="@("de")">üá©üá™ Allemand</MudSelectItem>
                        <MudSelectItem Value="@("en")">üá¨üáß Anglais</MudSelectItem>
                    </MudSelect>
                </MudItem>

                @* ======================================================== *@
                @* S√âCURIT√â                                                 *@
                @* ======================================================== *@
                <MudItem xs="12" Class="mt-4">
                    <MudText Typo="Typo.h6" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Class="me-2" />
                        S√©curit√©
                    </MudText>
                    <MudDivider />
                </MudItem>

                @* Mot de passe *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.Password"
                                  Label="Mot de passe"
                                  Variant="Variant.Outlined"
                                  InputType="@_passwordInputType"
                                  Required="true"
                                  RequiredError="Le mot de passe est obligatoire"
                                  Validation="@(new Func<string, string>(ValidatePassword))"
                                  Immediate="true"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_passwordIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  AdornmentAriaLabel="Afficher/Masquer le mot de passe" />
                </MudItem>

                @* Confirmation mot de passe *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.ConfirmPassword"
                                  Label="Confirmer le mot de passe"
                                  Variant="Variant.Outlined"
                                  InputType="@_passwordInputType"
                                  Required="true"
                                  RequiredError="La confirmation est obligatoire"
                                  Validation="@(new Func<string, string>(ValidateConfirmPassword))"
                                  Immediate="true"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_passwordIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  AdornmentAriaLabel="Afficher/Masquer le mot de passe" />
                </MudItem>

                @* ======================================================== *@
                @* R√îLES                                                    *@
                @* ======================================================== *@
                <MudItem xs="12" Class="mt-4">
                    <MudText Typo="Typo.h6" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Group" Class="me-2" />
                        R√¥les et permissions
                    </MudText>
                    <MudDivider />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.body2" Class="mb-3">
                        S√©lectionnez au moins un r√¥le pour cet utilisateur :
                    </MudText>

                    @* Administrateur *@
                    <MudCheckBox @bind-Value="@_isAdministrateur"
                                 Color="Color.Error"
                                 Dense="true"
                                 Label="Administrateur - Acc√®s complet √† toutes les fonctionnalit√©s" />

                    @* Moniteur *@
                    <MudCheckBox @bind-Value="@_isMoniteur"
                                 Color="Color.Warning"
                                 Dense="true"
                                 Label="Moniteur - Peut valider et g√©rer les r√©servations" />

                    @* Membre *@
                    <MudCheckBox @bind-Value="@_isMembre"
                                 Color="Color.Info"
                                 Dense="true"
                                 Label="Membre - Peut cr√©er et consulter ses r√©servations" />

                    @if (!_isAdministrateur && !_isMoniteur && !_isMembre)
                    {
                        <MudAlert Severity="Severity.Error" Class="mt-2" Dense="true">
                            Au moins un r√¥le doit √™tre s√©lectionn√©
                        </MudAlert>
                    }
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel"
                   Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Cancel">
            Annuler
        </MudButton>
        <MudButton OnClick="Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Save"
                   Disabled="@(!_formIsValid || _processing || (!_isAdministrateur && !_isMoniteur && !_isMembre))">
            @if (_processing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <span class="ms-2">Cr√©ation...</span>
            }
            else
            {
                <span>Cr√©er l'utilisateur</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // ================================================================
    // PARAM√àTRES DU DIALOGUE
    // ================================================================

    [CascadingParameter]
    public MudBlazor.IDialogReference? DialogRef { get; set; }

    // ================================================================
    // VARIABLES D'√âTAT
    // ================================================================

    /// <summary>
    /// R√©f√©rence au formulaire MudForm.
    /// Permet de valider le formulaire avant la soumission.
    /// </summary>
    private MudForm _form = null!;

    /// <summary>
    /// Indique si le formulaire est valide.
    /// Activ√©/d√©sactive le bouton de soumission.
    /// </summary>
    private bool _formIsValid;

    /// <summary>
    /// Mod√®le de donn√©es pour le nouvel utilisateur.
    /// </summary>
    private CreateUserDto _model = new();

    /// <summary>
    /// Indique si une op√©ration est en cours.
    /// Affiche un spinner pendant la cr√©ation.
    /// </summary>
    private bool _processing = false;

    /// <summary>
    /// Type d'input pour les champs mot de passe.
    /// Permet de basculer entre texte visible et masqu√©.
    /// </summary>
    private InputType _passwordInputType = InputType.Password;

    /// <summary>
    /// Ic√¥ne pour afficher/masquer le mot de passe.
    /// </summary>
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    /// <summary>
    /// Indique si l'utilisateur a le r√¥le Administrateur.
    /// </summary>
    private bool _isAdministrateur = false;

    /// <summary>
    /// Indique si l'utilisateur a le r√¥le Moniteur.
    /// </summary>
    private bool _isMoniteur = false;

    /// <summary>
    /// Indique si l'utilisateur a le r√¥le Membre.
    /// Par d√©faut true (tous les utilisateurs sont au moins Membre).
    /// </summary>
    private bool _isMembre = true;

    // ================================================================
    // INITIALISATION
    // ================================================================

    protected override void OnInitialized()
    {
        // D√©finir les valeurs par d√©faut
        _model.PreferenceLangue = "fr";
    }

    // ================================================================
    // VALIDATION
    // ================================================================

    /// <summary>
    /// Valide le mot de passe.
    /// Minimum 6 caract√®res.
    /// </summary>
    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Le mot de passe est obligatoire";

        if (password.Length < 6)
            return "Le mot de passe doit contenir au moins 6 caract√®res";

        return null;
    }

    /// <summary>
    /// Valide la confirmation du mot de passe.
    /// Doit correspondre au mot de passe.
    /// </summary>
    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (string.IsNullOrWhiteSpace(confirmPassword))
            return "La confirmation est obligatoire";

        if (confirmPassword != _model.Password)
            return "Les mots de passe ne correspondent pas";

        return null;
    }

    /// <summary>
    /// Bascule la visibilit√© du mot de passe.
    /// </summary>
    private void TogglePasswordVisibility()
    {
        if (_passwordInputType == InputType.Password)
        {
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    // ================================================================
    // ACTIONS
    // ================================================================

    /// <summary>
    /// Annule la cr√©ation et ferme le dialogue.
    /// </summary>
    private void Cancel()
    {
        DialogRef?.Close(DialogResult.Cancel());
    }

    /// <summary>
    /// Soumet le formulaire et cr√©e l'utilisateur.
    /// </summary>
    private async Task Submit()
    {
        // Valide le formulaire
        await _form.Validate();

        if (!_formIsValid)
        {
            Snackbar.Add("Veuillez corriger les erreurs du formulaire", Severity.Error);
            return;
        }

        // V√©rifie qu'au moins un r√¥le est s√©lectionn√©
        if (!_isAdministrateur && !_isMoniteur && !_isMembre)
        {
            Snackbar.Add("Au moins un r√¥le doit √™tre s√©lectionn√©", Severity.Error);
            return;
        }

        try
        {
            _processing = true;

            // Construit la liste des r√¥les
            _model.Roles = new List<string>();
            if (_isAdministrateur) _model.Roles.Add(RoleConstants.Administrateur);
            if (_isMoniteur) _model.Roles.Add(RoleConstants.Moniteur);
            if (_isMembre) _model.Roles.Add(RoleConstants.Membre);

            // Appelle le service pour cr√©er l'utilisateur
            var (success, message) = await UserService.CreateUserAsync(_model);

            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                DialogRef?.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur inattendue : {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }
}
