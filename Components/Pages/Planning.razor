@page "/planning"
@using CTSAR.Booking.Services
@using CTSAR.Booking.DTOs
@using CTSAR.Booking.Data
@using CTSAR.Booking.Components.Dialogs
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using System.Security.Claims
@using Microsoft.JSInterop
@inject ReservationService ReservationService
@inject AlveoleService AlveoleService
@inject FermetureClubService FermetureClubService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IStringLocalizer<Planning> Loc
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@attribute [Authorize]

@implements IAsyncDisposable

<PageTitle>@Loc["PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header avec navigation mois - Responsive -->
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="@(!_isMobile)" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Justify="@(_isMobile ? Justify.Center : Justify.FlexStart)">
                <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                               Color="Color.Primary"
                               OnClick="@PreviousMonth" />
                <MudText Typo="@(_isMobile ? Typo.h6 : Typo.h5)">
                    @GetMonthYearLabel(_currentMonth, _currentYear)
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                               Color="Color.Primary"
                               OnClick="@NextMonth" />
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Size="@(_isMobile ? Size.Small : Size.Medium)"
                           OnClick="@GoToToday">
                    @Loc["Today"]
                </MudButton>
            </MudStack>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       FullWidth="@_isMobile"
                       Size="@(_isMobile ? Size.Medium : Size.Medium)"
                       OnClick="@OpenCreateReservationDialog">
                @Loc["NewReservation"]
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Légende des statuts - Responsive -->
    <MudPaper Class="pa-3 mb-4">
        <MudStack Row="@(!_isMobile)" Spacing="@(_isMobile ? 2 : 4)">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Success" Size="Size.Small" />
                <MudText Typo="Typo.body2">@Loc["StatusConfirmed"]</MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Warning" Size="Size.Small" />
                <MudText Typo="Typo.body2">@Loc["StatusPending"]</MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Error" Size="Size.Small" />
                <MudText Typo="Typo.body2">@Loc["StatusClosed"]</MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (_isMobile)
    {
        <!-- Vue liste pour mobile -->
        @foreach (var day in GetDaysInMonth())
        {
            var reservations = GetReservationsForDay(day);
            var fermetures = GetFermeturesForDay(day);
            var hasContent = reservations.Any() || fermetures.Any();
            var isToday = day.Date == DateTime.Now.Date;

            @if (hasContent || isToday)
            {
                <MudCard Class="mb-3" Outlined="true" Style="@(isToday ? "border: 2px solid var(--mud-palette-primary);" : "")">
                    <MudCardHeader Style="padding: 12px 16px;">
                        <CardHeaderContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h6" Style="@(isToday ? "color: var(--mud-palette-primary); font-weight: bold;" : "")">
                                    @day.ToString("dddd dd MMMM", System.Globalization.CultureInfo.CurrentCulture)
                                </MudText>
                                @if (isToday)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@Loc["Today"]</MudChip>
                                }
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="padding: 8px 16px 16px 16px;">
                        <MudStack Spacing="2">
                            @if (!hasContent)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@Loc["NoReservations"]</MudText>
                            }
                            else
                            {
                                <!-- Réservations du jour -->
                                @foreach (var reservation in reservations)
                                {
                                    <MudAlert Severity="@GetReservationSeverity(reservation)"
                                              Dense="false"
                                              NoIcon="false"
                                              Icon="@GetReservationIcon(reservation)"
                                              Style="cursor: pointer;"
                                              @onclick="@(() => OpenReservationDetails(reservation))">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                            @reservation.DateDebut.ToLocalTime().ToString("HH:mm") - @reservation.NomsAlveoles
                                        </MudText>
                                        <MudText Typo="Typo.body2" Style="font-size: 0.875rem;">
                                            @if (reservation.StatutReservation == StatutReservation.Confirmee && reservation.MoniteurPrincipal != null)
                                            {
                                                <text>@Loc["Instructor"]: @reservation.MoniteurPrincipal.NomComplet</text>
                                            }
                                            else
                                            {
                                                <text>@Loc["CreatedBy"]: @reservation.CreatedByNom</text>
                                            }
                                        </MudText>
                                    </MudAlert>
                                }

                                <!-- Fermetures du jour -->
                                @foreach (var fermeture in fermetures)
                                {
                                    <MudAlert Severity="Severity.Error"
                                              Dense="false"
                                              NoIcon="false"
                                              Icon="@Icons.Material.Filled.Block">
                                        <MudText Typo="Typo.body2">@GetFermetureLabel(fermeture)</MudText>
                                    </MudAlert>
                                }
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }
        }
    }
    else
    {
        <!-- Vue calendrier pour desktop -->
        <MudPaper Class="pa-4">
            <MudTable Items="@GetWeeksInMonth()"
                      Hover="false"
                      Dense="true"
                      Bordered="true"
                      Square="true"
                      Class="calendar-table">
                <HeaderContent>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Monday"]</MudTh>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Tuesday"]</MudTh>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Wednesday"]</MudTh>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Thursday"]</MudTh>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Friday"]</MudTh>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Saturday"]</MudTh>
                    <MudTh Style="text-align: center; font-weight: bold;">@Loc["Sunday"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @foreach (var day in context)
                    {
                        <MudTd Style="@($"vertical-align: top; padding: 8px; height: 120px; {GetDayStyle(day)}")">
                            @if (day.HasValue)
                            {
                                <MudStack Spacing="1">
                                    <!-- Numéro du jour -->
                                    <MudText Typo="Typo.body2"
                                             Style="@GetDayNumberStyle(day.Value)"
                                             Class="mb-1">
                                        @day.Value.Day
                                    </MudText>

                                    <!-- Réservations du jour -->
                                    @foreach (var reservation in GetReservationsForDay(day.Value))
                                    {
                                        <MudAlert Severity="@GetReservationSeverity(reservation)"
                                                  Dense="true"
                                                  NoIcon="false"
                                                  Icon="@GetReservationIcon(reservation)"
                                                  Class="my-1"
                                                  Style="font-size: 0.7rem; padding: 4px 8px; cursor: pointer;"
                                                  @onclick="@(() => OpenReservationDetails(reservation))">
                                            @GetReservationLabelWithPerson(reservation)
                                        </MudAlert>
                                    }

                                    <!-- Fermetures du jour -->
                                    @foreach (var fermeture in GetFermeturesForDay(day.Value))
                                    {
                                        <MudAlert Severity="Severity.Error"
                                                  Dense="true"
                                                  NoIcon="false"
                                                  Icon="@Icons.Material.Filled.Block"
                                                  Class="my-1"
                                                  Style="font-size: 0.7rem; padding: 4px 8px;">
                                            @GetFermetureLabel(fermeture)
                                        </MudAlert>
                                    }
                                </MudStack>
                            }
                        </MudTd>
                    }
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

<style>
    .calendar-table table {
        table-layout: fixed;
    }

    .calendar-table td {
        width: 14.28%; /* 100% / 7 jours */
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "year")]
    public int? Year { get; set; }

    [SupplyParameterFromQuery(Name = "month")]
    public int? Month { get; set; }

    private int _currentMonth;
    private int _currentYear;
    private List<ReservationDto>? _reservations;
    private List<AlveoleDto>? _alveoles;
    private List<FermetureClubDto>? _fermetures;
    private bool _loading = false;
    private string? _currentUserId;
    private bool _isMoniteur = false;
    private bool _isInitialized = false;
    private bool _isMobile = false;
    private DotNetObjectReference<Planning>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        var today = DateTime.Now;

        // Utiliser les paramètres d'URL s'ils sont présents, sinon utiliser le mois courant
        if (Year.HasValue && Month.HasValue && Month.Value >= 1 && Month.Value <= 12)
        {
            _currentYear = Year.Value;
            _currentMonth = Month.Value;
        }
        else
        {
            _currentMonth = today.Month;
            _currentYear = today.Year;
        }

        // Récupérer l'utilisateur connecté
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        _isMoniteur = authState.User.IsInRole("Moniteur");

        await LoadData();
        _isInitialized = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("window.planningHelper.initialize", _dotNetRef);

                // Détecter la taille initiale
                var width = await JSRuntime.InvokeAsync<int>("window.planningHelper.getWindowWidth");
                _isMobile = width <= 640;
                StateHasChanged();
            }
            catch (Exception)
            {
                // En cas d'erreur, assumer desktop par défaut
                _isMobile = false;
            }
        }
    }

    [JSInvokable]
    public async Task OnWindowResize(int width)
    {
        var wasMobile = _isMobile;
        _isMobile = width <= 640;

        if (wasMobile != _isMobile)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("window.planningHelper.dispose");
                _dotNetRef.Dispose();
            }
            catch
            {
                // Ignore errors during disposal
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Ne rien faire si le composant n'est pas encore initialisé
        if (!_isInitialized)
            return;

        // Détecter si les paramètres Year/Month ont changé
        var hasChanged = false;

        if (Year.HasValue && Month.HasValue && Month.Value >= 1 && Month.Value <= 12)
        {
            if (_currentYear != Year.Value || _currentMonth != Month.Value)
            {
                _currentYear = Year.Value;
                _currentMonth = Month.Value;
                hasChanged = true;
            }
        }

        // Recharger les données uniquement si les paramètres ont changé
        if (hasChanged)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        // Guard contre les appels concurrents multiples
        if (_loading) return;

        _loading = true;
        try
        {
            var reservationsTask = ReservationService.GetReservationsForMonthAsync(_currentYear, _currentMonth);
            var alveolesTask = AlveoleService.GetAllAlveolesAsync();
            var fermeturesTask = FermetureClubService.GetFermeturesForMonthAsync(_currentYear, _currentMonth);

            await Task.WhenAll(reservationsTask, alveolesTask, fermeturesTask);

            _reservations = await reservationsTask;
            _alveoles = await alveolesTask;
            _fermetures = await fermeturesTask;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur lors du chargement des données : {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task PreviousMonth()
    {
        _currentMonth--;
        if (_currentMonth < 1)
        {
            _currentMonth = 12;
            _currentYear--;
        }
        // NavigateToMonth pour mettre à jour l'URL
        NavigateToMonth(_currentYear, _currentMonth);
        // Chargement direct - le guard empêche les doubles appels
        await LoadData();
        StateHasChanged();
    }

    private async Task NextMonth()
    {
        _currentMonth++;
        if (_currentMonth > 12)
        {
            _currentMonth = 1;
            _currentYear++;
        }
        // NavigateToMonth pour mettre à jour l'URL
        NavigateToMonth(_currentYear, _currentMonth);
        // Chargement direct - le guard empêche les doubles appels
        await LoadData();
        StateHasChanged();
    }

    private void NavigateToMonth(int year, int month)
    {
        var uri = NavigationManager.GetUriWithQueryParameters(new Dictionary<string, object?>
        {
            ["year"] = year,
            ["month"] = month
        });
        NavigationManager.NavigateTo(uri);
    }

    private void GoToToday()
    {
        // Naviguer vers /planning sans paramètres (revient au mois courant)
        NavigationManager.NavigateTo("/planning");
    }

    private string GetMonthYearLabel(int month, int year)
    {
        var date = new DateTime(year, month, 1);
        return date.ToString("MMMM yyyy");
    }

    /// <summary>
    /// Génère la liste de tous les jours du mois (pour la vue liste mobile)
    /// </summary>
    private List<DateTime> GetDaysInMonth()
    {
        var days = new List<DateTime>();
        var firstDayOfMonth = new DateTime(_currentYear, _currentMonth, 1);
        var daysInMonth = DateTime.DaysInMonth(_currentYear, _currentMonth);

        for (int day = 1; day <= daysInMonth; day++)
        {
            days.Add(new DateTime(_currentYear, _currentMonth, day));
        }

        return days;
    }

    /// <summary>
    /// Génère les semaines du mois avec les jours (null pour les jours hors mois)
    /// </summary>
    private List<List<DateTime?>> GetWeeksInMonth()
    {
        var weeks = new List<List<DateTime?>>();
        var firstDayOfMonth = new DateTime(_currentYear, _currentMonth, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Trouver le lundi de la première semaine
        var currentDay = firstDayOfMonth;
        while (currentDay.DayOfWeek != DayOfWeek.Monday)
        {
            currentDay = currentDay.AddDays(-1);
        }

        // Générer les semaines
        while (currentDay <= lastDayOfMonth || currentDay.DayOfWeek != DayOfWeek.Monday)
        {
            var week = new List<DateTime?>();
            for (int i = 0; i < 7; i++)
            {
                if (currentDay.Month == _currentMonth)
                {
                    week.Add(currentDay);
                }
                else
                {
                    week.Add(null); // Jour hors du mois courant
                }
                currentDay = currentDay.AddDays(1);
            }
            weeks.Add(week);

            if (currentDay > lastDayOfMonth && currentDay.DayOfWeek == DayOfWeek.Monday)
                break;
        }

        return weeks;
    }

    private string GetDayStyle(DateTime? day)
    {
        if (!day.HasValue)
            return "background-color: var(--mud-palette-background-grey);";

        var today = DateTime.Now.Date;
        if (day.Value.Date == today)
            return "border: 3px solid var(--mud-palette-primary);";

        return "";
    }

    private string GetDayNumberStyle(DateTime day)
    {
        var today = DateTime.Now.Date;
        if (day.Date == today)
            return "font-weight: bold; color: var(--mud-palette-primary);";

        return "";
    }

    private List<ReservationDto> GetReservationsForDay(DateTime day)
    {
        if (_reservations == null)
            return new List<ReservationDto>();

        return _reservations
            .Where(r => r.DateDebut.Date == day.Date)
            .OrderBy(r => r.DateDebut.TimeOfDay)
            .ToList();
    }

    private Color GetReservationColor(ReservationDto reservation)
    {
        return reservation.StatutReservation == StatutReservation.Confirmee
            ? Color.Success
            : Color.Warning;
    }

    private string GetReservationLabel(ReservationDto reservation)
    {
        var time = reservation.DateDebut.ToLocalTime().ToString("HH:mm");
        var alveoles = string.Join(",", reservation.Alveoles.Select(a => a.Nom));
        return $"{time} {alveoles}";
    }

    private List<FermetureClubDto> GetFermeturesForDay(DateTime day)
    {
        if (_fermetures == null)
            return new List<FermetureClubDto>();

        return _fermetures
            .Where(f => f.DateDebut.Date <= day.Date && f.DateFin.Date >= day.Date)
            .OrderBy(f => f.DateDebut)
            .ToList();
    }

    private string GetFermetureLabel(FermetureClubDto fermeture)
    {
        var typeLabel = GetFermetureTypeLabel(fermeture.TypeFermeture);

        if (!string.IsNullOrWhiteSpace(fermeture.Raison))
        {
            return $"{typeLabel}: {fermeture.Raison}";
        }

        return typeLabel;
    }

    private string GetFermetureTypeLabel(TypeFermeture type)
    {
        return type switch
        {
            TypeFermeture.Travaux => Loc["TypeTravaux"],
            TypeFermeture.JourFerie => Loc["TypeJourFerie"],
            TypeFermeture.ReservationExterne => Loc["TypeReservationExterne"],
            TypeFermeture.Autre => Loc["TypeAutre"],
            _ => type.ToString()
        };
    }

    private Severity GetReservationSeverity(ReservationDto reservation)
    {
        return reservation.StatutReservation == StatutReservation.Confirmee
            ? Severity.Success
            : Severity.Warning;
    }

    private string GetReservationIcon(ReservationDto reservation)
    {
        return reservation.StatutReservation == StatutReservation.Confirmee
            ? Icons.Material.Filled.CheckCircle
            : Icons.Material.Filled.HourglassBottom;
    }

    private string GetReservationLabelWithPerson(ReservationDto reservation)
    {
        var timeLabel = $"{reservation.DateDebut.ToLocalTime():HH:mm} {reservation.NomsAlveoles}";

        if (reservation.StatutReservation == StatutReservation.Confirmee && reservation.MoniteurPrincipal != null)
        {
            return $"{timeLabel} - {Loc["Instructor"]}: {reservation.MoniteurPrincipal.NomComplet}";
        }
        else
        {
            return $"{timeLabel} - {Loc["CreatedBy"]}: {reservation.CreatedByNom}";
        }
    }

    private async Task OpenCreateReservationDialog()
    {
        var parameters = new DialogParameters
        {
            { "CurrentYear", _currentYear },
            { "CurrentMonth", _currentMonth }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = _isMobile ? MaxWidth.ExtraSmall : MaxWidth.Small,
            FullWidth = true,
            FullScreen = _isMobile
        };

        var dialog = await DialogService.ShowAsync<CreateReservationDialog>(Loc["NewReservation"], parameters, options);
        var result = await dialog.Result;

        // Toujours rafraîchir le calendrier après fermeture du dialogue
        // pour afficher les nouvelles réservations
        await LoadData();
        StateHasChanged();
    }

    private async Task OpenReservationDetails(ReservationDto reservation)
    {
        var parameters = new DialogParameters
        {
            { "ReservationId", reservation.Id }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = _isMobile ? MaxWidth.ExtraSmall : MaxWidth.Medium,
            FullWidth = true,
            FullScreen = _isMobile
        };

        var dialog = await DialogService.ShowAsync<ReservationDetailsDialog>(Loc["ReservationDetails"], parameters, options);
        var result = await dialog.Result;

        // Si l'utilisateur a modifié la réservation, recharger les données
        if (!result.Canceled)
        {
            await LoadData();
            StateHasChanged();
        }
    }
}
