@page "/register"

@using Microsoft.Extensions.Localization
@using CTSAR.Booking.Data

@inject IStringLocalizer<CTSAR.Booking.Resources.Auth> Loc
@inject NavigationManager Navigation

<PageTitle>@Loc["RegisterTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-6">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
            @Loc["RegisterTitle"]
        </MudText>
        <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-6">
            @Loc["RegisterSubtitle"]
        </MudText>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                @errorMessage
            </MudAlert>
        }

        <form method="post" action="/api/auth/register-page" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="prenom"
                                  Label="@Loc["FirstName"]"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  name="prenom" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="nom"
                                  Label="@Loc["LastName"]"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  name="nom" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="email"
                                  Label="@Loc["Email"]"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Required="true"
                                  name="email" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="password"
                                  Label="@Loc["Password"]"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Required="true"
                                  name="password" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="confirmPassword"
                                  Label="@Loc["ConfirmPassword"]"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Required="true"
                                  name="confirmPassword" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelect @bind-Value="selectedRole"
                               Label="@Loc["Role"]"
                               Variant="Variant.Outlined"
                               Required="true"
                               name="role">
                        <MudSelectItem Value="@RoleNames.Membre">@Loc["RoleMembre"]</MudSelectItem>
                        <MudSelectItem Value="@RoleNames.Moniteur">@Loc["RoleMoniteur"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <input type="hidden" name="returnUrl" value="@ReturnUrl" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       FullWidth="true"
                       Class="mt-6"
                       ButtonType="ButtonType.Submit"
                       Disabled="isLoading">
                @if (isLoading)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    @Loc["CreatingAccount"]
                }
                else
                {
                    @Loc["RegisterButton"]
                }
            </MudButton>
        </form>

        <MudDivider Class="my-6" />

        <MudText Align="Align.Center">
            @Loc["AlreadyHaveAccount"]
            <MudLink Href="/login">@Loc["LoginHere"]</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private bool isLoading;
    private string email = "";
    private string password = "";
    private string confirmPassword = "";
    private string nom = "";
    private string prenom = "";
    private string selectedRole = RoleNames.Membre;
    private string? errorMessage;

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery(Name = "error")]
    private string? Error { get; set; }

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(Error))
        {
            errorMessage = Error switch
            {
                "exists" => Loc["EmailAlreadyExists"],
                "passwordmismatch" => Loc["PasswordMismatch"],
                "weak" => Loc["PasswordTooWeak"],
                _ => Loc["UnexpectedError"]
            };
        }
    }

    private void HandleSubmit()
    {
        isLoading = true;
    }
}
