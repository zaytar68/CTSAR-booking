@page "/admin/test-notifications"
@using CTSAR.Booking.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IJSRuntime JS
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IPushNotificationService PushService
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Roles = "Administrateur")]

<PageTitle>Test Notifications Push</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">üîî Test des Notifications Push</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Page de test pour v√©rifier le bon fonctionnement des notifications push Web
    </MudText>

    <MudGrid>
        <!-- Carte : Statut du navigateur -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">üì± Support Navigateur</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        <strong>Service Worker:</strong>
                        @if (_isServiceWorkerSupported)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úì Support√©</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small">‚úó Non support√©</MudChip>
                        }
                    </MudText>

                    <MudText Typo="Typo.body2" Class="mb-2">
                        <strong>Push Manager:</strong>
                        @if (_isPushSupported)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úì Support√©</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small">‚úó Non support√©</MudChip>
                        }
                    </MudText>

                    <MudText Typo="Typo.body2" Class="mb-2">
                        <strong>Permission actuelle:</strong>
                        @if (_permissionStatus == "granted")
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úì Accord√©e</MudChip>
                        }
                        else if (_permissionStatus == "denied")
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small">‚úó Refus√©e</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">‚ö† Non demand√©e</MudChip>
                        }
                    </MudText>

                    <MudText Typo="Typo.body2">
                        <strong>Abonn√©:</strong>
                        @if (_isSubscribed)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úì Oui</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Default" Size="Size.Small">Non</MudChip>
                        }
                    </MudText>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="CheckStatus"
                               StartIcon="@Icons.Material.Filled.Refresh">
                        Rafra√Æchir
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Carte : Actions -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">‚ö° Actions</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   Disabled="@(!_isPushSupported || _permissionStatus == "denied")"
                                   OnClick="RequestPermission"
                                   StartIcon="@Icons.Material.Filled.Notifications">
                            1. Demander la permission
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   FullWidth="true"
                                   Disabled="@(_permissionStatus != "granted" || _isSubscribed)"
                                   OnClick="Subscribe"
                                   StartIcon="@Icons.Material.Filled.NotificationAdd">
                            2. S'abonner aux notifications
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Info"
                                   FullWidth="true"
                                   Disabled="@(_permissionStatus != "granted")"
                                   OnClick="ShowLocalNotification"
                                   StartIcon="@Icons.Material.Filled.Notifications">
                            3. Test notification locale
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   FullWidth="true"
                                   Disabled="@(!_isSubscribed)"
                                   OnClick="SendTestNotification"
                                   StartIcon="@Icons.Material.Filled.Send">
                            4. Envoyer notification push serveur
                        </MudButton>

                        <MudDivider />

                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Error"
                                   FullWidth="true"
                                   Disabled="@(!_isSubscribed)"
                                   OnClick="Unsubscribe"
                                   StartIcon="@Icons.Material.Filled.NotificationsOff">
                            Se d√©sabonner
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Carte : Souscriptions actives -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">üìã Mes Souscriptions Actives</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                       Color="Color.Default"
                                       OnClick="LoadSubscriptions" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @if (_subscriptions == null)
                    {
                        <MudProgressCircular Indeterminate="true" />
                    }
                    else if (!_subscriptions.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Aucune souscription active
                        </MudText>
                    }
                    else
                    {
                        <MudSimpleTable Dense="true" Striped="true">
                            <thead>
                                <tr>
                                    <th>User-Agent</th>
                                    <th>Cr√©√©e le</th>
                                    <th>Derni√®re utilisation</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var sub in _subscriptions)
                                {
                                    <tr>
                                        <td>@sub.UserAgent</td>
                                        <td>@sub.CreatedAt.ToString("g")</td>
                                        <td>@(sub.LastUsedAt?.ToString("g") ?? "Jamais")</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Carte : Logs -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">üìù Logs</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Clear"
                                       Color="Color.Default"
                                       OnClick="() => _logs.Clear()" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudPaper Class="pa-2" Style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; font-size: 0.85rem;">
                        @foreach (var log in _logs)
                        {
                            <div>@log</div>
                        }
                        @if (!_logs.Any())
                        {
                            <div style="color: #888;">Aucun log...</div>
                        }
                    </MudPaper>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private bool _isServiceWorkerSupported;
    private bool _isPushSupported;
    private string _permissionStatus = "default";
    private bool _isSubscribed;
    private List<SubscriptionInfo>? _subscriptions;
    private List<string> _logs = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            //  Utiliser Task.Run pour ex√©cuter l'initialisation en arri√®re-plan
            _ = Task.Run(async () =>
            {
                await Task.Delay(200); // Donner le temps au composant de finir le rendu
                await InitializePushApi();
                await CheckStatus();
                await LoadSubscriptions();
            });
        }
    }

    private async Task InitializePushApi()
    {
        try
        {
            // Charger le script dynamiquement s'il n'est pas d√©j√† charg√©
            var isLoaded = await JS.InvokeAsync<bool>("eval", "typeof PushNotifications !== 'undefined'");

            if (!isLoaded)
            {
                AddLog("‚è≥ Chargement du script push-notifications.js...");

                try
                {
                    // Charger le script dynamiquement avec une Promise qui attend l'√©v√©nement onload
                    await JS.InvokeVoidAsync("eval", @"
                        new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = '/js/push-notifications.js';
                            script.onload = () => {
                                console.log('[Blazor] Script push-notifications.js loaded');
                                resolve();
                            };
                            script.onerror = (error) => {
                                console.error('[Blazor] Failed to load push-notifications.js:', error);
                                reject(error);
                            };
                            document.head.appendChild(script);
                        })
                    ");

                    // V√©rifier que le script est bien charg√©
                    isLoaded = await JS.InvokeAsync<bool>("eval", "typeof PushNotifications !== 'undefined'");

                    if (isLoaded)
                    {
                        AddLog("   ‚úì Script charg√© dynamiquement");
                    }
                    else
                    {
                        AddLog("   ‚úó Script charg√© mais PushNotifications non d√©fini");
                        return;
                    }
                }
                catch (Exception ex)
                {
                    AddLog($"   ‚úó Erreur lors du chargement : {ex.Message}");
                    return;
                }
            }
            else
            {
                AddLog("‚úì Script push-notifications.js d√©j√† charg√©");
            }

            AddLog("üîë R√©cup√©ration de la cl√© publique VAPID...");

            // R√©cup√©rer la cl√© publique depuis l'API
            var response = await Http.GetFromJsonAsync<VapidKeyResponse>("/api/pushnotifications/vapid-public-key");

            if (response?.PublicKey != null)
            {
                // Initialiser l'API JavaScript avec la cl√©
                await JS.InvokeVoidAsync("pushNotifications.initialize", response.PublicKey);
                AddLog($"   ‚úì API initialis√©e");
            }
            else
            {
                AddLog("   ‚úó Cl√© publique introuvable");
            }
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur initialisation: {ex.Message}");
        }
    }

    private async Task CheckStatus()
    {
        try
        {
            AddLog("üîç V√©rification du statut...");

            // V√©rifier le support
            _isServiceWorkerSupported = await JS.InvokeAsync<bool>("eval",
                "'serviceWorker' in navigator");
            _isPushSupported = await JS.InvokeAsync<bool>("pushNotifications.isSupported");

            AddLog($"   Service Worker: {(_isServiceWorkerSupported ? "‚úì" : "‚úó")}");
            AddLog($"   Push Manager: {(_isPushSupported ? "‚úì" : "‚úó")}");

            if (_isPushSupported)
            {
                _permissionStatus = await JS.InvokeAsync<string>("pushNotifications.getPermissionStatus");
                _isSubscribed = await JS.InvokeAsync<bool>("pushNotifications.isSubscribed");

                AddLog($"   Permission: {_permissionStatus}");
                AddLog($"   Abonn√©: {(_isSubscribed ? "‚úì" : "‚úó")}");
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur: {ex.Message}");
            Snackbar.Add($"Erreur: {ex.Message}", Severity.Error);
        }
    }

    private async Task RequestPermission()
    {
        try
        {
            AddLog("üîî Demande de permission...");

            var permission = await JS.InvokeAsync<string>("pushNotifications.requestPermission");
            _permissionStatus = permission;

            AddLog($"   R√©sultat: {permission}");

            if (permission == "granted")
            {
                Snackbar.Add("Permission accord√©e !", Severity.Success);
            }
            else if (permission == "denied")
            {
                Snackbar.Add("Permission refus√©e. V√©rifiez les param√®tres du navigateur.", Severity.Warning);
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur: {ex.Message}");
            Snackbar.Add($"Erreur: {ex.Message}", Severity.Error);
        }
    }

    private async Task Subscribe()
    {
        try
        {
            AddLog("üìù Cr√©ation de la souscription...");

            // Appeler la m√©thode JavaScript qui g√®re tout
            await JS.InvokeVoidAsync("pushNotifications.sendSubscriptionToServer");

            _isSubscribed = true;
            AddLog("   ‚úì Souscription cr√©√©e avec succ√®s");
            Snackbar.Add("Abonnement r√©ussi !", Severity.Success);

            await LoadSubscriptions();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur: {ex.Message}");
            Snackbar.Add($"Erreur lors de l'abonnement: {ex.Message}", Severity.Error);
        }
    }

    private async Task Unsubscribe()
    {
        try
        {
            AddLog("üîï Suppression de la souscription...");

            await JS.InvokeVoidAsync("pushNotifications.removeSubscriptionFromServer");

            _isSubscribed = false;
            AddLog("   ‚úì Souscription supprim√©e");
            Snackbar.Add("D√©sabonnement r√©ussi", Severity.Info);

            await LoadSubscriptions();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur: {ex.Message}");
            Snackbar.Add($"Erreur lors du d√©sabonnement: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowLocalNotification()
    {
        try
        {
            AddLog("üîî Test notification locale (sans serveur)...");

            // V√©rifier que le script est charg√©
            var isLoaded = await JS.InvokeAsync<bool>("eval", "typeof PushNotifications !== 'undefined'");
            if (!isLoaded)
            {
                AddLog("   ‚úó Script push-notifications.js non charg√©");
                Snackbar.Add("Erreur: Script non charg√©. Rafra√Æchissez la page (Ctrl+F5)", Severity.Error);
                return;
            }

            var result = await JS.InvokeAsync<bool>(
                "PushNotifications.showTestNotification",
                "CTSAR Booking - Test Local",
                "Cette notification est g√©n√©r√©e localement par le navigateur"
            );

            if (result)
            {
                AddLog("   ‚úì Notification locale affich√©e");
                Snackbar.Add("Notification locale affich√©e avec succ√®s !", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur notification locale: {ex.Message}");
            Snackbar.Add($"Erreur: Rafra√Æchissez la page avec Ctrl+F5", Severity.Error);
        }
    }

    private async Task SendTestNotification()
    {
        try
        {
            AddLog("üöÄ Envoi de la notification push serveur...");

            // R√©cup√©rer l'utilisateur actuel
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
            {
                AddLog("   ‚úó Utilisateur non authentifi√©");
                Snackbar.Add("Erreur: Vous devez √™tre connect√©", Severity.Error);
                return;
            }

            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userIdClaim) || !int.TryParse(userIdClaim, out int userId))
            {
                AddLog("   ‚úó Impossible de r√©cup√©rer l'ID utilisateur");
                Snackbar.Add("Erreur: ID utilisateur invalide", Severity.Error);
                return;
            }

            AddLog($"   UserId: {userId}");

            // Cr√©er la notification de test
            var notification = new PushNotificationDto
            {
                Title = "Test - CTSAR Booking",
                Body = "Ceci est une notification de test. Vos notifications fonctionnent correctement !",
                Url = "/",
                Tag = "test"
            };

            AddLog($"   Titre: {notification.Title}");
            AddLog($"   Message: {notification.Body}");

            // Appeler directement le service
            var success = await PushService.SendAsync(userId, notification);

            if (success)
            {
                AddLog("   ‚úì Notification push envoy√©e avec succ√®s !");
                Snackbar.Add("Notification push envoy√©e ! V√©rifiez votre navigateur.", Severity.Success);
                await LoadSubscriptions(); // Rafra√Æchir pour voir LastUsedAt
            }
            else
            {
                AddLog("   ‚úó √âchec de l'envoi de la notification");
                Snackbar.Add("Erreur: Impossible d'envoyer la notification", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur: {ex.Message}");
            AddLog($"‚ùå StackTrace: {ex.StackTrace}");
            Snackbar.Add($"Erreur: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadSubscriptions()
    {
        try
        {
            // R√©cup√©rer l'utilisateur actuel
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
            {
                _subscriptions = new List<SubscriptionInfo>();
                return;
            }

            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userIdClaim) || !int.TryParse(userIdClaim, out int userId))
            {
                _subscriptions = new List<SubscriptionInfo>();
                return;
            }

            // Appeler directement le service
            var subscriptions = await PushService.GetUserSubscriptionsAsync(userId);

            _subscriptions = subscriptions.Select(s => new SubscriptionInfo
            {
                Id = s.Id,
                Endpoint = s.Endpoint.Substring(0, Math.Min(50, s.Endpoint.Length)) + "...",
                UserAgent = s.UserAgent ?? "Inconnu",
                CreatedAt = s.CreatedAt,
                LastUsedAt = s.LastUsedAt
            }).ToList();

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            AddLog($"‚ùå Erreur chargement souscriptions: {ex.Message}");
        }
    }

    private void AddLog(string message)
    {
        _logs.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {message}");
        if (_logs.Count > 50) // Limiter √† 50 logs
        {
            _logs.RemoveAt(_logs.Count - 1);
        }
    }

    private class SubscriptionInfo
    {
        public int Id { get; set; }
        public string Endpoint { get; set; } = string.Empty;
        public string UserAgent { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public DateTime? LastUsedAt { get; set; }
    }

    private class VapidKeyResponse
    {
        public string PublicKey { get; set; } = string.Empty;
    }
}
